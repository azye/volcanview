<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ðŸŒ‹HOT VOLCANOESðŸŒ‹</title>
    <meta charset="utf-8" />
    <!-- Include the CesiumJS JavaScript and CSS files -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.87.1/Build/Cesium/Cesium.js"></script>
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.87.1/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
  </head>

  <style>
    .app .data .map {
      position: relative;
    }
    html,
    body,
    #cesiumContainer,
    .leaflet-container {
      position: absolute;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #volcanoSelectorContainer {
      position: absolute;
      z-index: 9;
      padding-left: 10px;
      padding-top: 10px;
    }
  </style>

  <body>
    <div id="volcanoSelectorContainer">
      <input
        type="text"
        list="volcanoList"
        id="volcanoSearch"
        placeholder="Seach ðŸŒ‹ here..."
      />
      <datalist id="volcanoList"> </datalist>
    </div>
    <div id="cesiumContainer"></div>

    <script>
      const DEV_API_KEY = "";
      const PROD_API_KEY = "AIzaSyCPb-qYWd8dLi_gKdUfceU72XXPIv5KDHs";
      // force volcano to load by using volcano # here. volcano # is console logged during first load or search.
      // 0 or false for random volcano on load.
      const FORCE_VOLCANO = 0;
      const heading = Cesium.Math.toRadians(50.0);
      const pitch = Cesium.Math.toRadians(-30.0);
      const range = 15000.0;
      let rotationUnsub;
      // Set the Cesium Ion token to `null` to avoid warnings
      Cesium.Ion.defaultAccessToken = null;

      let volcanoList = [];
      function RequestNextPage(NextPage) {
        return fetch(
          `https://www.ngdc.noaa.gov/hazel/hazard-service/api/v1/volcanolocs?page=${NextPage}`,
          {
            method: "GET",
          }
        )
          .then(function (response) {
            return response.json();
          })
          .then(function (json) {
            volcanoList = volcanoList.concat(json.items);
            if (json.page < json.totalPages) {
              return RequestNextPage(json.page + 1);
            }
          })
          .catch(function (err) {
            console.log(`Error: ${err}`);
          });
      }

      const volcanoSearch = document.getElementById("volcanoSearch");

      volcanoSearch.addEventListener("change", (event) => {
        const volcanoNumber = volcanoList.findIndex(
          (x) => x.name === event.target.value
        );
        const currentVolcano = volcanoList[volcanoNumber];
        console.debug("SELECTED VOLCANO: ", volcanoNumber, currentVolcano);

        if (!currentVolcano) {
          return;
        }

        const nc = Cesium.Cartesian3.fromDegrees(
          currentVolcano.longitude,
          currentVolcano.latitude,
          currentVolcano.elevation
        );
        viewer.camera.lookAt(
          nc,
          new Cesium.HeadingPitchRange(heading, pitch, range)
        );
        viewer.camera.lookDown(3 * 0.05);
      });

      function FirstRequestToGraph() {
        return fetch(
          "https://www.ngdc.noaa.gov/hazel/hazard-service/api/v1/volcanolocs",
          {
            method: "GET",
          }
        )
          .then(function (response) {
            return response.json();
          })
          .then(function (json) {
            volcanoList = volcanoList.concat(json.items);
            if (json.page < json.totalPages) {
              return RequestNextPage(json.page + 1);
            }
          })
          .catch(function (err) {
            console.log(`Error: ${err}`);
          });
      }

      let randomVolcano;

      function getRandomInt(max) {
        return Math.floor(Math.random() * max);
      }

      const defaultProps = {
        animation: false,
        timeline: false,
        infoBox: false,
        homeButton: false,
        vrButton: false,
        sceneModePicker: false,
        timeline: false,
        selectionIndicator: false,
        navigationHelpButton: false,
        geocoder: false,
        fullscreenButton: false,
        selectionIndicator: false,
        globe: false,
        creditContainer: document.createElement("none"),
      };

      let tileset;
      const apiKey = DEV_API_KEY.length > 0 ? DEV_API_KEY : PROD_API_KEY;
      viewer = new Cesium.Viewer("cesiumContainer", {
        imageryProvider: false,
        baseLayerPicker: false,
        ...defaultProps,
      });
      tileset = viewer.scene.primitives.add(
        new Cesium.Cesium3DTileset({
          url: `https://tile.googleapis.com/v1/3dtiles/root.json?key=${apiKey}`,
        })
      );
      viewer.scene.screenSpaceCameraController.minimumZoomDistance = 5000;
      viewer.scene.screenSpaceCameraController.maximumZoomDistance = 35000;
      viewer.scene.screenSpaceCameraController._minimumZoomRate = 300;

      FirstRequestToGraph().then(() => {
        const datalist = document.getElementById("volcanoList");

        volcanoList.forEach((volcano, index) => {
          const option = document.createElement("option");
          option.value = volcano.name;
          datalist.appendChild(option);
        });
        const volcanoNum = FORCE_VOLCANO
          ? FORCE_VOLCANO
          : getRandomInt(volcanoList.length);
        randomVolcano = volcanoList[volcanoNum];
        console.debug("SELECTED VOLCANO: ", volcanoNum, randomVolcano);

        const center = Cesium.Cartesian3.fromDegrees(
          randomVolcano.longitude,
          randomVolcano.latitude,
          randomVolcano.elevation
        );

        document.getElementById("volcanoSearch").value = randomVolcano.name;
        // viewer.camera.flyTo({
        //     destination: center,
        // });
        viewer.camera.lookAt(
          center,
          new Cesium.HeadingPitchRange(heading, pitch, range)
        );
        viewer.camera.lookDown(3 * 0.05);

        // Orbit this point
        rotationUnsub = viewer.clock.onTick.addEventListener(function (clock) {
          viewer.scene.camera.rotateLeft(0.001);
        });
      });

      let isRotationRight; // yeah, i know...

      document.addEventListener('keyup', event => {
        if (event.code === 'Space') {
          if (rotationUnsub) {
            rotationUnsub()
            isRotationRight = !isRotationRight
            rotationUnsub = undefined
            return
          }
          rotationUnsub = viewer.clock.onTick.addEventListener(function (clock) {
            isRotationRight ?  viewer.scene.camera.rotateRight(0.002) : viewer.scene.camera.rotateLeft(0.002);
          });
        }
      })

      document.addEventListener('keydown', event => {
        if (event.code === 'ArrowLeft') {
          viewer.scene.camera.rotateLeft(0.07)
        }
        if (event.code === 'ArrowRight') {
          viewer.scene.camera.rotateRight(0.07)
        }
      })

      // tileset.loadProgress.addEventListener(function(numberOfPendingRequests, numberOfTilesProcessing) {
      // if ((numberOfPendingRequests === 0) && (numberOfTilesProcessing === 0)) {
      //     console.log('Stopped loading');
      //     return;
      // }
      //     debugger;
      //     console.log(`Loading: requests: ${numberOfPendingRequests}, processing: ${numberOfTilesProcessing}`);
      // });

      // tileset.tileLoad.addEventListener(() => {
      //   loading.style.display = ''
      // })

      // tileset.allTilesLoaded.addEventListener(() => {
      //   loading.style.display = 'none'
      // })

    </script>
  </body>
</html>
